# ========================================================
# CI Pipeline - Smart Scheduling (QA Environment)
# ========================================================

name: Smart Scheduling CI QA

on:
  push:
    branches:
      - qa
  pull_request:
    branches:
      - qa
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # 1. Clonar el repositorio
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------
      # 2. Configurar JDK 21
      # -----------------------------
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      # -----------------------------
      # 3. Crear archivo .env desde secretos
      # -----------------------------
      - name: Create .env file
        run: |
          echo "DB_URL=${{ secrets.DB_URL }}" >> .env
          echo "DB_USER=${{ secrets.DB_USER }}" >> .env
          echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env
          echo "SERVER_PORT=8080" >> .env
          echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
          echo "JWT_EXPIRATION=86400000" >> .env

      # -----------------------------
      # 4. Ejecutar pruebas unitarias (todas)
      # -----------------------------
      - name: Run unit tests
        run: mvn test -Dsurefire.failIfNoSpecifiedTests=false

      # -----------------------------
      # 5. Generar reporte de cobertura
      # -----------------------------
      - name: Generate coverage report
        run: mvn jacoco:report

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: target/site/jacoco

      # -----------------------------
      # 6. Validar estilo de cÃ³digo
      # -----------------------------
      - name: Run Checkstyle
        run: mvn checkstyle:check || true

      # -----------------------------
      # 7. Compilar proyecto (sin tests)
      # -----------------------------
      - name: Build with Maven
        run: mvn -B package -DskipTests

      # -----------------------------
      # 8. Construir imagen Docker
      # -----------------------------
      - name: Build Docker image
        run: docker build -t smart-scheduling:latest .

      # -----------------------------
      # 9. Ejecutar contenedor para pruebas de API
      # -----------------------------
      - name: Start container for API tests
        run: |
          echo "ðŸš€ Starting Smart Scheduling container..."
          docker run -d \
            --name smart-scheduling-test \
            --env-file .env \
            -p 8080:8080 \
            smart-scheduling:latest
          
          echo "âŒ› Waiting for API to be ready..."
          for i in {1..30}; do
            if curl -s http://localhost:8080/actuator/health >/dev/null; then
              echo "âœ… API is ready!"
              break
            fi
            sleep 2
          done

      # -----------------------------
      # 10. Exportar OpenAPI spec (springdoc)
      # -----------------------------
      - name: Export OpenAPI spec (springdoc)
        run: |
          echo "ðŸ“„ Fetching OpenAPI spec from /v3/api-docs..."
          curl -s http://localhost:8080/v3/api-docs | jq . > target/openapi.json

      - name: Upload OpenAPI spec
        uses: actions/upload-artifact@v4
        with:
          name: openapi-spec
          path: target/openapi.json

      # -----------------------------
      # 11. Instalar Hurl
      # -----------------------------
      - name: Setup Hurl (API testing tool)
        uses: gacts/install-hurl@v1

      # -----------------------------
      # 12. Ejecutar pruebas Hurl por entidad
      # -----------------------------
      - name: Run Hurl API tests
        run: |
          echo "ðŸ§ª Running Hurl tests..."
          for file in tests/**/*.hurl; do
            echo "ðŸ” Testing: $file"
            hurl "$file" --test --error-format long --variable host=http://localhost:8080
          done
          
          echo "ðŸ§¹ Cleaning up test environment..."
          docker logs smart-scheduling-test > target/container.log || true
          docker stop smart-scheduling-test || true
          docker rm smart-scheduling-test || true

      # -----------------------------
      # 13. Subir artefactos de logs
      # -----------------------------
      - name: Upload API test logs
        uses: actions/upload-artifact@v4
        with:
          name: api-test-logs
          path: target/container.log
